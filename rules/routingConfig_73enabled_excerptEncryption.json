{
  "rules": {
    "start": {
      "description": "root rule. decision between laboratory and disease path",
      "fhirPathExpression": "Bundle.meta.profile.contains('https://demis.rki.de/fhir/StructureDefinition/NotificationBundleLaboratory')",
      "result": {},
      "followingRules": {
        "conditionFulfilled": "laboratory_detect_7_1",
        "conditionNotMet": "disease_detect_6_1"
      }
    },
    "laboratory_detect_7_1": {
      "description": "root condition to identify 7.1 cases",
      "fhirPathExpression": "Bundle.meta.profile = 'https://demis.rki.de/fhir/StructureDefinition/NotificationBundleLaboratory'",
      "followingRules": {
        "conditionFulfilled": "laboratory_narrow_down_7_1_cases",
        "conditionNotMet": "laboratory_distinguish_7_3_from_7_4"
      },
      "result": {}
    },
    "laboratory_narrow_down_7_1_cases": {
      "description": "narrow down specific 7.1 cases",
      "fhirPathExpression": "Bundle.entry.resource.where($this is Composition).subject.reference.resolve().meta.profile = 'https://demis.rki.de/fhir/StructureDefinition/NotifiedPersonAnonymous'",
      "followingRules": {
        "conditionNotMet": "laboratory_narrow_down_7_1_cases_by_pathogen"
      },
      "result": {
        "conditionFulfilled": "laboratory_7_1_anonymous_follow_up"
      }
    },
    "laboratory_narrow_down_7_1_cases_by_pathogen": {
      "description": "Distinguish between a regular 7.1, tuberculosis-related 7.1 or a COVID-related 7.1",
      "fhirPathExpression": "Bundle.entry.resource.where($this is Composition).section.entry.reference.resolve().code.coding.where(code = 'cvdp').empty().not()",
      "followingRules": {
        "conditionNotMet": "laboratory_distinguish_7_1_tuberculosis_from_7_1_regular"
      },
      "result": {
        "conditionFulfilled": "laboratory_7_1_covid"
      }
    },
    "laboratory_distinguish_7_1_tuberculosis_from_7_1_regular": {
      "description": "Distinguish between a regular 7.1 or a tuberculosis-related 7.1",
      "fhirPathExpression": "Bundle.entry.resource.where($this is Composition).section.entry.reference.resolve().code.coding.where(code = 'mytp').empty().not()",
      "result": {
        "conditionNotMet": "laboratory_7_1",
        "conditionFulfilled": "laboratory_7_1_tuberculosis"
      }
    },
    "laboratory_distinguish_7_3_from_7_4": {
      "description": "narrow down specific 7.3 cases or detect 7.4 cases",
      "fhirPathExpression": "Bundle.meta.profile = 'https://demis.rki.de/fhir/StructureDefinition/NotificationBundleLaboratoryNonNominal' or Bundle.meta.profile = 'https://demis.rki.de/fhir/StructureDefinition/NotificationBundleLaboratoryAnonymous'",
      "followingRules": {
        "conditionFulfilled": "laboratory_distinguish_7_3_anonymous_from_7_3_regular",
        "conditionNotMet": "laboratory_detect_7_4"
      },
      "result": {}
    },
    "laboratory_distinguish_7_3_anonymous_from_7_3_regular": {
      "description": "narrow down specific 7.3 cases",
      "fhirPathExpression": "Bundle.meta.profile = 'https://demis.rki.de/fhir/StructureDefinition/NotificationBundleLaboratoryNonNominal'",
      "followingRules": {},
      "result": {
        "conditionFulfilled": "laboratory_7_3",
        "conditionNotMet": "laboratory_7_3_anonymous"
      }
    },
    "laboratory_detect_7_4": {
      "description": "matches 7.4 cases",
      "fhirPathExpression": "Bundle.meta.profile = 'https://demis.rki.de/fhir/StructureDefinition/NotificationBundleLaboratoryNegative'",
      "followingRules": {},
      "result": {
        "conditionFulfilled": "laboratory_7_4"
      }
    },
    "disease_detect_6_1": {
      "description": "pick 6.1 or check 7.3 disease",
      "fhirPathExpression": "Bundle.meta.profile = 'https://demis.rki.de/fhir/StructureDefinition/NotificationBundleDisease'",
      "followingRules": {
        "conditionFulfilled": "disease_narrow_down_6_1_cases",
        "conditionNotMet": "disease_distinguish_7_3_anonymous_from_7_3_regular"
      },
      "result": {}
    },
    "disease_narrow_down_6_1_cases": {
      "description": "",
      "fhirPathExpression": "Bundle.entry.resource.where($this is Composition).subject.reference.resolve().meta.profile = 'https://demis.rki.de/fhir/StructureDefinition/NotifiedPersonAnonymous'",
      "followingRules": {
        "conditionNotMet": "disease_narrow_down_6_1_cases_by_pathogen"
      },
      "result": {
        "conditionFulfilled": "disease_6_1_anonymous_follow_up"
      }
    },
    "disease_narrow_down_6_1_cases_by_pathogen": {
      "description": "",
      "fhirPathExpression": "Bundle.entry.resource.where($this is Composition).section.entry.reference.resolve().code.coding.where(code = 'cvdd').empty().not()",
      "followingRules": {
        "conditionNotMet": "disease_distinguish_6_1_tuberculosis_from_6_1_regular"
      },
      "result": {
        "conditionFulfilled": "disease_6_1_covid"
      }
    },
    "disease_distinguish_6_1_tuberculosis_from_6_1_regular": {
      "description": "",
      "fhirPathExpression": "Bundle.entry.resource.where($this is Composition).section.entry.reference.resolve().code.coding.where(code = 'mytd' or code = 'mybd').empty().not()",
      "followingRules": { },
      "result": {
        "conditionFulfilled": "disease_6_1_tuberculosis",
        "conditionNotMet": "disease_6_1"
      }
    },
    "disease_distinguish_7_3_anonymous_from_7_3_regular": {
      "description": "",
      "fhirPathExpression": "Bundle.entry.resource.where($this is Composition).subject.reference.resolve().meta.profile = 'https://demis.rki.de/fhir/StructureDefinition/NotifiedPerson'",
      "followingRules": {},
      "result": {
        "conditionFulfilled": "disease_7_3",
        "conditionNotMet": "disease_7_3_anonymous"
      }
    }
  },
  "results": {
    "laboratory_7_1": {
      "description": "if this case is active the notification is a §7.1 case. the standard lookup must be used",
      "type": "laboratory",
      "notificationCategory": "7.1",
      "bundleActions": [
        {
          "type": "create_pseudonym_record",
          "optional": true
        }
      ],
      "routesTo": [
        {
          "type": "responsible_health_office",
          "optional": "false",
          "actions": [
            "encrypt"
          ]
        },
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "pseudo_copy",
            "encrypt"
          ]
        }
      ],
      "allowedRoles": ["pathogen-notification-sender"]
    },
    "laboratory_7_1_covid": {
      "description": "if this case is active the notification is a §7.1 case. the standard lookup must be used",
      "type": "laboratory",
      "notificationCategory": "7.1",
      "bundleActions": [
        {
          "type": "create_pseudonym_record",
          "optional": true
        }
      ],
      "routesTo": [
        {
          "type": "responsible_health_office",
          "optional": "false",
          "actions": [
            "encrypt"
          ]
        },
        {
          "type": "responsible_health_office_sormas",
          "optional": "true",
          "actions": [
            "encrypt"
          ]
        },
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "pseudo_copy",
            "encrypt"
          ]
        }
      ],
      "allowedRoles": ["pathogen-notification-sender"]
    },
    "laboratory_7_1_tuberculosis": {
      "description": "7.1 tuberculosis case: lookup the responsible healthoffice and check if there is a specialised one dealing with tuberculosis ",
      "type": "laboratory",
      "notificationCategory": "7.1",
      "bundleActions": [{"type": "create_pseudonym_record", "optional":  true}],
      "routesTo": [
        {
          "type": "responsible_health_office_tuberculosis",
          "optional": "false",
          "actions": ["encrypt"]
        },
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "pseudo_copy",
            "encrypt"
          ]
        }
      ],
      "allowedRoles": ["pathogen-notification-sender"]
    },
    "laboratory_7_1_anonymous_follow_up": {
      "description": "if this case is active the notification is a §7.1 case with a relates to id. the relates to id has to be used to find the responsible health office.",
      "type": "laboratory",
      "notificationCategory": "7.1",
      "bundleActions": [
        {
          "type": "no_action",
          "optional": true
        }
      ],
      "routesTo": [
        {
          "type": "responsible_health_office_with_relates_to",
          "optional": "false",
          "actions": [
            "encrypt"
          ]
        },
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "pseudo_copy",
            "encrypt"
          ]
        }
      ],
      "allowedRoles": ["pathogen-notification-sender"]
    },
    "laboratory_7_3": {
      "description": "if this case is active the notification is a §7.3 case. it should only be send to the RKI.",
      "type": "laboratory",
      "notificationCategory": "7.3",
      "bundleActions": [
        {
          "type": "create_pseudonym_record",
          "optional": false
        }
      ],
      "routesTo": [
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "reproduce",
            "encrypt"
          ]
        },
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "pseudo_copy",
            "encrypt"
          ]
        }
      ],
      "allowedRoles": ["pathogen-notification-nonnominal-sender"]
    },
    "laboratory_7_3_anonymous": {
      "description": "if this case is active the notification is a §7.3 anonymous case. it should only be send to the RKI.",
      "type": "laboratory",
      "notificationCategory": "7.3",
      "bundleActions": [
        {
          "type": "no_action",
          "optional": false
        }
      ],
      "routesTo": [
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "reproduce",
            "encrypt"
          ]
        },
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "pseudo_copy",
            "encrypt"
          ]
        }
      ],
      "allowedRoles": ["pathogen-notification-anonymous-sender"]
    },
    "laboratory_7_4": {
      "description": "if this case is active the notification is a §7.4 case. this must be send to the RKI.",
      "type": "laboratory",
      "notificationCategory": "7.4",
      "bundleActions": [
        {
          "type": "no_action",
          "optional": false
        }
      ],
      "routesTo": [
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "no_action"
          ]
        }
      ],
      "allowedRoles": ["pathogen-notification-negative-sender"]
    },
    "disease_6_1": {
      "description": "if this case is active the notification is a §6.1 case. the standard lookup must be used",
      "type": "disease",
      "notificationCategory": "6.1",
      "bundleActions": [
        {
          "type": "create_pseudonym_record",
          "optional": true
        }
      ],
      "routesTo": [
        {
          "type": "responsible_health_office",
          "optional": "false",
          "actions": [
            "encrypt"
          ]
        },
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "pseudo_copy",
            "encrypt"
          ]
        }
      ],
      "allowedRoles": ["disease-notification-sender"]
    },
    "disease_6_1_covid": {
      "description": "if this case is active the notification is a §6.1 case. the standard lookup must be used",
      "type": "disease",
      "notificationCategory": "6.1",
      "bundleActions": [
        {
          "type": "create_pseudonym_record",
          "optional": true
        }
      ],
      "routesTo": [
        {
          "type": "responsible_health_office",
          "optional": "false",
          "actions": [
            "encrypt"
          ]
        },
        {
          "type": "responsible_health_office_sormas",
          "optional": "true",
          "actions": [
            "encrypt"
          ]
        },
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "pseudo_copy",
            "encrypt"
          ]
        }
      ],
      "allowedRoles": ["disease-notification-sender"]
    },
    "disease_6_1_tuberculosis": {
      "description": "6.1 tuberculosis case: lookup the responsible healthoffice and check if there is a specialised one dealing with tuberculosis ",
      "type": "disease",
      "notificationCategory": "6.1",
      "bundleActions": [{"type": "create_pseudonym_record", "optional":  true}],
      "routesTo": [
        {
          "type": "responsible_health_office_tuberculosis",
          "optional": "false",
          "actions": ["encrypt"]
        },
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "pseudo_copy",
            "encrypt"
          ]
        }
      ],
      "allowedRoles": ["disease-notification-sender"]
    },
    "disease_6_1_anonymous_follow_up": {
      "description": "if this case is active the notification is a §6.1 case with a relates to id. the relates to id has to be used to find the responsible health office.",
      "type": "disease",
      "notificationCategory": "6.1",
      "bundleActions": [
        {
          "type": "no_action",
          "optional": true
        }
      ],
      "routesTo": [
        {
          "type": "responsible_health_office_with_relates_to",
          "optional": "false",
          "actions": [
            "encrypt"
          ]
        },
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "pseudo_copy",
            "encrypt"
          ]
        }
      ],
      "allowedRoles": ["disease-notification-sender"]
    },
    "disease_7_3": {
      "description": "if this case is active the notification is a §7.3 case. it should only be send to the RKI.",
      "type": "disease",
      "notificationCategory": "7.3",
      "bundleActions": [
        {
          "type": "create_pseudonym_record",
          "optional": false
        }
      ],
      "routesTo": [
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "reproduce",
            "encrypt"
          ]
        },
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "pseudo_copy",
            "encrypt"
          ]
        }
      ],
      "allowedRoles": ["disease-notification-nonnominal-sender"]
    },
    "disease_7_3_anonymous": {
      "description": "if this case is active the notification is a §7.3 case. it should only be send to the RKI.",
      "type": "disease",
      "notificationCategory": "7.3",
      "bundleActions": [
        {
          "type": "create_pseudonym_record",
          "optional": false
        }
      ],
      "routesTo": [
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "reproduce",
            "encrypt"
          ]
        },
        {
          "type": "specific_receiver",
          "specificReceiverId": "1.",
          "optional": "false",
          "actions": [
            "pseudo_copy",
            "encrypt"
          ]
        }
      ],
      "allowedRoles": ["disease-notification-anonymous-sender"]
    }
  }
}
